---
title: 关于一个项目多个环境的问题理解和解决办法
date: 2019-11-16 21:10:17
categories: react
top: 100
tags:
    - react
    - 学习笔记和总结
photos: 
    - "https://desk-fd.zol-img.com.cn/t_s1440x900c5/g5/M00/0C/00/ChMkJ13VHGeIQbMvAAZiH-yBkAsAAvVdQCGfhkABmI3388.jpg"
---
<!--more-->
问题：由于项目有多个环境（uat,dev,stg1,stg2）,现在的需求是更具不同的环境，要控制页面上一个按钮的显示和隐藏。

问题分析和处理： 
本地通过在yarn dev 命令里面通过传入不同的参数，然后页面通过js获取到不同环境的参数： 比如在开发环境中:

```package.json
"scripts": {
    "start": "cross-env BASE_PATH=/ PLATFORM_VERSION=OP CLIENT_ID=localhost BPM_HOST=http://256.000.00.127:8170 API_HOST=http://256.000.00.127:8080 WEBSOCKET_HOST=ws:/256.000.00.127:8120 SRC_WEBSOCKET_URL=http://256.000.00.127:8500 node --max_old_space_size=4196 scripts/start.js",
    "dev": "cross-env BASE_PATH=/ PLATFORM_VERSION=SAAS CLIENT_ID=gjoy-front-dev BPM_HOST=http://256.000.00.127:8170 API_HOST=http://256.000.00.127:8080 WEBSOCKET_HOST=http://256.000.00.127:8120 SRC_WEBSOCKET_URL=http://256.000.00.127:8500 node --max_old_space_size=8196 scripts/start.js",
    "build": "npm run lint:fix && cross-env BASE_PATH=/ WEBSOCKET_HOST=BUILD_WEBSOCKET_HOST BPM_HOST=BUILD_BPM_HOST CLIENT_ID=BUILD_CLIENT_ID API_HOST=BUILD_API_HOST GENERATE_SOURCEMAP=false node --max_old_space_size=4196 scripts/build.js",
  },
```
脚本涵义：
cross-env 运行跨平台设置和使用环境变量的脚本，（npm i --save-dev cross-env 安装使用）
dev、 build分别表示开发环境和线上环境
CLIENT_ID： 对应的值就是gjoy-front-dev
BPM_HOST: 对应的值为http://192.168.16.172:8170
总之： 等号前面就是参数的名字，后面就是参数的值。
在页面上就可以通过： process.env.xxx 来获取对应参数的值


1. 最简单的解决方式： 在不同的环境中 设置不同的环境变量，然后在jenkins构建的时候 不同的环境执行不同的命令就可以了。
比如：
uat环境构建的时候 ： 设置CLIENT_ID为project_name_uat
```
build:uat: "npm run lint:fix && cross-env CLIENT_ID=project_name_uat  node --max_old_space_size=4196 scripts/build.js"
```
dev环境构建的时候 ： 设置CLIENT_ID为project_name_dev
```
build:dev: "npm run lint:fix && cross-env CLIENT_ID=project_name_uat  node --max_old_space_size=4196 scripts/build.js"
```
stg环境构建的时候 ： 设置CLIENT_ID为project_name_stg
```
build:stg: "npm run lint:fix && cross-env CLIENT_ID=project_name_uat  node --max_old_space_size=4196 scripts/build.js"
```
这种方式：就是要在package.json中的scirpt中要写不同环境的不同命令。


但是在jenkins中写死了构建的时候调用的时候 `yarn build`
```
"build": "npm run lint:fix && cross-env BASE_PATH=/ WEBSOCKET_HOST=BUILD_WEBSOCKET_HOST BPM_HOST=BUILD_BPM_HOST CLIENT_ID=BUILD_CLIENT_ID API_HOST=BUILD_API_HOST GENERATE_SOURCEMAP=false node --max_old_space_size=4196 scripts/build.js",
```
这个命令，且他们不想在修改构建命令中指令。所以另外在构建的时候需要在服务器中跑sh脚本 将构建完成的代码中使用到这个环境变量的地方，批量替换了。

```
cd /opt/gjoy/apps/hces-front
#git reset --hard
git pull
export PUPPETEER_SKIP_CHROMIUM_DOWNLOAD=1 #macos/linux
#rm -rf ./node_modules
#rm -rf ./yarn.lock
#安装依赖 
#yarn add choerodon-ui --registry=http://nexus.saas.hand-china.com/content/groups/hzero-npm-group/ -W -flag
yarn bootstrap
#编译子模块
lerna run transpile
#打包dll 
yarn build:dll
# 构建
yarn build
cd /usr/share/nginx/html/gjoy/
rm -rf dist
cp -r /opt/gjoy/apps/hces-front/dist .
./setup.sh
```
setup.sh 

